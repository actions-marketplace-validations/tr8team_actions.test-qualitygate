import { literal, number, object } from "zod";
import { BasePolicy } from "./base-policy";
const anyDeltaCoveragePolicy = object({
    type: literal("any-delta-coverage-policy"),
    warn: number().min(-100).max(100),
    fail: number().min(-100).max(100),
})
    .required()
    .strict();
class AnyDeltaCoveragePolicy extends BasePolicy {
    #config;
    constructor(name, target, config) {
        super(name, target);
        this.#config = config;
    }
    evaluate(current) {
        // ensure that current's coverage must have not dropped below base coverage, if possible
        return this.filteredEvaluate(current, (item) => {
            if (item.data.type === "test-coverage") {
                const { data } = item;
                return data.delta
                    .map((delta) => {
                    const fWarn = data.function === 100
                        ? Math.min(this.#config.warn, delta.function)
                        : this.#config.warn;
                    const lWarn = data.line === 100
                        ? Math.min(this.#config.warn, delta.line)
                        : this.#config.warn;
                    const bWarn = data.branch === 100
                        ? Math.min(this.#config.warn, delta.branch)
                        : this.#config.warn;
                    const sWarn = data.statement === 100
                        ? Math.min(this.#config.warn, delta.statement)
                        : this.#config.warn;
                    const fFail = data.function === 100
                        ? Math.min(this.#config.fail, delta.function)
                        : this.#config.fail;
                    const lFail = data.line === 100
                        ? Math.min(this.#config.fail, delta.line)
                        : this.#config.fail;
                    const bFail = data.branch === 100
                        ? Math.min(this.#config.fail, delta.branch)
                        : this.#config.fail;
                    const sFail = data.statement === 100
                        ? Math.min(this.#config.fail, delta.statement)
                        : this.#config.fail;
                    let verdict = "pass";
                    if (delta.function < fWarn ||
                        delta.line < lWarn ||
                        delta.branch < bWarn ||
                        delta.statement < sWarn) {
                        verdict = "warn";
                    }
                    if (delta.function < fFail ||
                        delta.line < lFail ||
                        delta.branch < bFail ||
                        delta.statement < sFail) {
                        verdict = "fail";
                    }
                    return this.updateElement(item, verdict);
                })
                    .unwrapOr(item);
            }
            return Promise.resolve(item);
        });
    }
}
export { anyDeltaCoveragePolicy, AnyDeltaCoveragePolicy };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW55LWRlbHRhLWNvdmVyYWdlLXBvbGljeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9saWIvcG9saWN5L2FueS1kZWx0YS1jb3ZlcmFnZS1wb2xpY3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFLLE1BQU0sS0FBSyxDQUFDO0FBQ2pELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFRM0MsTUFBTSxzQkFBc0IsR0FBRyxNQUFNLENBQUM7SUFDcEMsSUFBSSxFQUFFLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQztJQUMxQyxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztJQUNqQyxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztDQUNsQyxDQUFDO0tBQ0MsUUFBUSxFQUFFO0tBQ1YsTUFBTSxFQUFFLENBQUM7QUFJWixNQUFNLHNCQUF1QixTQUFRLFVBQVU7SUFDcEMsT0FBTyxDQUErQjtJQUUvQyxZQUNFLElBQVksRUFDWixNQUFjLEVBQ2QsTUFBb0M7UUFFcEMsS0FBSyxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztRQUNwQixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztJQUN4QixDQUFDO0lBRUQsUUFBUSxDQUFDLE9BQTBCO1FBQ2pDLHdGQUF3RjtRQUN4RixPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FDMUIsT0FBTyxFQUNQLENBQUMsSUFBSSxFQUFnQyxFQUFFO1lBQ3JDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssZUFBZSxFQUFFO2dCQUN0QyxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFD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QUFNLEdBQUcsS0FBSzt3QkFDcEIsS0FBSyxDQUFDLFNBQVMsR0FBRyxLQUFLLEVBQ3ZCO3dCQUNBLE9BQU8sR0FBRyxNQUFNLENBQUM7cUJBQ2xCO29CQUNELE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQzNDLENBQUMsQ0FBQztxQkFDRCxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDbkI7WUFDRCxPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUNGLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFFRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsc0JBQXNCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGxpdGVyYWwsIG51bWJlciwgb2JqZWN0LCB6IH0gZnJvbSBcInpvZFwiO1xuaW1wb3J0IHsgQmFzZVBvbGljeSB9IGZyb20gXCIuL2Jhc2UtcG9saWN5XCI7XG5pbXBvcnQgeyBQb2xpY3kgfSBmcm9tIFwiLi4vaW50ZXJmYWNlL3BvbGljeVwiO1xuaW1wb3J0IHtcbiAgSW50ZXJtZWRpYXRlRWxlbWVudCxcbiAgSW50ZXJtZWRpYXRlRW50cnksXG4gIFBvbGljeVJlc3VsdCxcbn0gZnJvbSBcIi4uL291dHB1dFwiO1xuXG5jb25zdCBhbnlEZWx0YUNvdmVyYWdlUG9saWN5ID0gb2JqZWN0KHtcbiAgdHlwZTogbGl0ZXJhbChcImFueS1kZWx0YS1jb3ZlcmFnZS1wb2xpY3lcIiksXG4gIHdhcm46IG51bWJlcigpLm1pbigtMTAwKS5tYXgoMTAwKSxcbiAgZmFpbDogbnVtYmVyKCkubWluKC0xMDApLm1heCgxMDApLFxufSlcbiAgLnJlcXVpcmVkKClcbiAgLnN0cmljdCgpO1xuXG50eXBlIEFueURlbHRhQ292ZXJhZ2VQb2xpY3lDb25maWcgPSB6LmluZmVyPHR5cGVvZiBhbnlEZWx0YUNvdmVyYWdlUG9saWN5PjtcblxuY2xhc3MgQW55RGVsdGFDb3ZlcmFnZVBvbGljeSBleHRlbmRzIEJhc2VQb2xpY3kgaW1wbGVtZW50cyBQb2xpY3kge1xuICByZWFkb25seSAjY29uZmlnOiBBbnlEZWx0YUNvdmVyYWdlUG9saWN5Q29uZmlnO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICB0YXJnZXQ6IHN0cmluZyxcbiAgICBjb25maWc6IEFueURlbHRhQ292ZXJhZ2VQb2xpY3lDb25maWdcbiAgKSB7XG4gICAgc3VwZXIobmFtZSwgdGFyZ2V0KTtcbiAgICB0aGlzLiNjb25maWcgPSBjb25maWc7XG4gIH1cblxuICBldmFsdWF0ZShjdXJyZW50OiBJbnRlcm1lZGlhdGVFbnRyeSk6IFByb21pc2U8SW50ZXJtZWRpYXRlRW50cnk+IHtcbiAgICAvLyBlbnN1cmUgdGhhdCBjdXJyZW50J3MgY292ZXJhZ2UgbXVzdCBoYXZlIG5vdCBkcm9wcGVkIGJlbG93IGJhc2UgY292ZXJhZ2UsIGlmIHBvc3NpYmxlXG4gICAgcmV0dXJuIHRoaXMuZmlsdGVyZWRFdmFsdWF0ZShcbiAgICAgIGN1cnJlbnQsXG4gICAgICAoaXRlbSk6IFByb21pc2U8SW50ZXJtZWRpYXRlRWxlbWVudD4gPT4ge1xuICAgICAgICBpZiAoaXRlbS5kYXRhLnR5cGUgPT09IFwidGVzdC1jb3ZlcmFnZVwiKSB7XG4gICAgICAgICAgY29uc3QgeyBkYXRhIH0gPSBpdGVtO1xuICAgICAgICAgIHJldHVybiBkYXRhLmRlbHRhXG4gICAgICAgICAgICAubWFwKChkZWx0YSkgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBmV2FybiA9XG4gICAgICAgICAgICAgICAgZGF0YS5mdW5jdGlvbiA9PT0gMTAwXG4gICAgICAgICAgICAgICAgICA/IE1hdGgubWluKHRoaXMuI2NvbmZpZy53YXJuLCBkZWx0YS5mdW5jdGlvbilcbiAgICAgICAgICAgICAgICAgIDogdGhpcy4jY29uZmlnLndhcm47XG4gICAgICAgICAgICAgIGNvbnN0IGxXYXJuID1cbiAgICAgICAgICAgICAgICBkYXRhLmxpbmUgPT09IDEwMFxuICAgICAgICAgICAgICAgICAgPyBNYXRoLm1pbih0aGlzLiNjb25maWcud2FybiwgZGVsdGEubGluZSlcbiAgICAgICAgICAgICAgICAgIDogdGhpcy4jY29uZmlnLndhcm47XG4gICAgICAgICAgICAgIGNvbnN0IGJXYXJuID1cbiAgICAgICAgICAgICAgICBkYXRhLmJyYW5jaCA9PT0gMTAwXG4gICAgICAgICAgICAgICAgICA/IE1hdGgubWluKHRoaXMuI2NvbmZpZy53YXJuLCBkZWx0YS5icmFuY2gpXG4gICAgICAgICAgICAgICAgICA6IHRoaXMuI2NvbmZpZy53YXJuO1xuICAgICAgICAgICAgICBjb25zdCBzV2FybiA9XG4gICAgICAgICAgICAgICAgZGF0YS5zdGF0ZW1lbnQgPT09IDEwMFxuICAgICAgICAgICAgICAgICAgPyBNYXRoLm1pbih0aGlzLiNjb25maWcud2FybiwgZGVsdGEuc3RhdGVtZW50KVxuICAgICAgICAgICAgICAgICAgOiB0aGlzLiNjb25maWcud2FybjtcblxuICAgICAgICAgICAgICBjb25zdCBmRmFpbCA9XG4gICAgICAgICAgICAgICAgZGF0YS5mdW5jdGlvbiA9PT0gMTAwXG4gICAgICAgICAgICAgICAgICA/IE1hdGgubWluKHRoaXMuI2NvbmZpZy5mYWlsLCBkZWx0YS5mdW5jdGlvbilcbiAgICAgICAgICAgICAgICAgIDogdGhpcy4jY29uZmlnLmZhaWw7XG4gICAgICAgICAgICAgIGNvbnN0IGxGYWlsID1cbiAgICAgICAgICAgICAgICBkYXRhLmxpbmUgPT09IDEwMFxuICAgICAgICAgICAgICAgICAgPyBNYXRoLm1pbih0aGlzLiNjb25maWcuZmFpbCwgZGVsdGEubGluZSlcbiAgICAgICAgICAgICAgICAgIDogdGhpcy4jY29uZmlnLmZhaWw7XG4gICAgICAgICAgICAgIGNvbnN0IGJGYWlsID1cbiAgICAgICAgICAgICAgICBkYXRhLmJyYW5jaCA9PT0gMTAwXG4gICAgICAgICAgICAgICAgICA/IE1hdGgubWluKHRoaXMuI2NvbmZpZy5mYWlsLCBkZWx0YS5icmFuY2gpXG4gICAgICAgICAgICAgICAgICA6IHRoaXMuI2NvbmZpZy5mYWlsO1xuICAgICAgICAgICAgICBjb25zdCBzRmFpbCA9XG4gICAgICAgICAgICAgICAgZGF0YS5zdGF0ZW1lbnQgPT09IDEwMFxuICAgICAgICAgICAgICAgICAgPyBNYXRoLm1pbih0aGlzLiNjb25maWcuZmFpbCwgZGVsdGEuc3RhdGVtZW50KVxuICAgICAgICAgICAgICAgICAgOiB0aGlzLiNjb25maWcuZmFpbDtcblxuICAgICAgICAgICAgICBsZXQgdmVyZGljdDogUG9saWN5UmVzdWx0ID0gXCJwYXNzXCI7XG4gICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBkZWx0YS5mdW5jdGlvbiA8IGZXYXJuIHx8XG4gICAgICAgICAgICAgICAgZGVsdGEubGluZSA8IGxXYXJuIHx8XG4gICAgICAgICAgICAgICAgZGVsdGEuYnJhbmNoIDwgYldhcm4gfHxcbiAgICAgICAgICAgICAgICBkZWx0YS5zdGF0ZW1lbnQgPCBzV2FyblxuICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICB2ZXJkaWN0ID0gXCJ3YXJuXCI7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGRlbHRhLmZ1bmN0aW9uIDwgZkZhaWwgfHxcbiAgICAgICAgICAgICAgICBkZWx0YS5saW5lIDwgbEZhaWwgfHxcbiAgICAgICAgICAgICAgICBkZWx0YS5icmFuY2ggPCBiRmFpbCB8fFxuICAgICAgICAgICAgICAgIGRlbHRhLnN0YXRlbWVudCA8IHNGYWlsXG4gICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHZlcmRpY3QgPSBcImZhaWxcIjtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVFbGVtZW50KGl0ZW0sIHZlcmRpY3QpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC51bndyYXBPcihpdGVtKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKGl0ZW0pO1xuICAgICAgfVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IHsgYW55RGVsdGFDb3ZlcmFnZVBvbGljeSwgQW55RGVsdGFDb3ZlcmFnZVBvbGljeSB9O1xuZXhwb3J0IHR5cGUgeyBBbnlEZWx0YUNvdmVyYWdlUG9saWN5Q29uZmlnIH07XG4iXX0=